name: Update Stats KV

on:
  schedule:
    - cron: "0 */6 * * *"   # every 6 hours
  workflow_dispatch:        # allow manual run

jobs:
  update-kv:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install Wrangler + jq
        run: |
          apt-get update && apt-get install -y jq curl
          npm install -g wrangler

      - name: Fetch stats and update KV
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          KV_NAMESPACE_ID: ${{ secrets.KV_NAMESPACE_ID }}
        run: |
          set -e

          echo "Fetching DockerHub stats..."
          docker_pulls=$(curl -s https://hub.docker.com/v2/repositories/makroumi/slowql/ | jq -r .pull_count)

          echo "Fetching PyPI stats..."
          pypi_recent=$(curl -s https://pypistats.org/api/packages/slowql/recent)
          pypi_last_day=$(echo $pypi_recent | jq -r .data.last_day)
          pypi_last_week=$(echo $pypi_recent | jq -r .data.last_week)
          pypi_last_month=$(echo $pypi_recent | jq -r .data.last_month)

          echo "Fetching PyPI total downloads..."
          pypi_total=$(curl -s https://pepy.tech/api/projects/slowql | jq -r .total_downloads)

          echo "Updating KV..."
          wrangler kv key put docker_pulls "$docker_pulls" --namespace-id "$KV_NAMESPACE_ID"
          wrangler kv key put pypi_last_day "$pypi_last_day" --namespace-id "$KV_NAMESPACE_ID"
          wrangler kv key put pypi_last_week "$pypi_last_week" --namespace-id "$KV_NAMESPACE_ID"
          wrangler kv key put pypi_last_month "$pypi_last_month" --namespace-id "$KV_NAMESPACE_ID"
          wrangler kv key put pypi_total_downloads "$pypi_total" --namespace-id "$KV_NAMESPACE_ID"
          wrangler kv key put cached_at "$(date +%s)" --namespace-id "$KV_NAMESPACE_ID"

          echo "KV update complete âœ…"
